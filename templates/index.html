<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ancient Greece QA Chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <style>
    body {
      transition: background-color 0.3s, color 0.3s;
      font-family: 'Poppins', sans-serif;
    }
    body.light-mode {
      background: linear-gradient(to right, #f0f2f5, #ffffff);
      color: #000;
    }
    body.dark-mode {
      background: linear-gradient(to right, #121212, #1a1a1a);
      color: #fff;
    }
    .chat-container {
      border-radius: 10px;
      padding: 20px;
      height: 70vh;
      overflow-y: auto;
      background-color: inherit;
    }
    .chat-entry {
      display: flex;
      margin-bottom: 15px;
    }
    .chat-entry.user {
      flex-direction: row-reverse;
      text-align: right;
    }
    .chat-bubble {
      max-width: 70%;
      padding: 12px;
      border-radius: 15px;
      margin: 0 10px;
      position: relative;
      white-space: pre-wrap;
    }
    .chat-bubble.user-msg {
      background-color: #0d6efd;
      color: white;
    }
    .chat-bubble.bot-msg {
      background-color: #e4e6eb;
    }
    .dark-mode .chat-bubble.bot-msg {
      background-color: #333;
    }
    .dark-mode .chat-bubble.user-msg {
      background-color: #007bff;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .timestamp {
      font-size: 0.75rem;
      margin-top: 5px;
      opacity: 0.7;
    }
    .sidebar {
      height: 70vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 15px;
    }
    .sidebar-entry {
      margin-bottom: 10px;
      font-size: 0.9rem;
      border-bottom: 1px dashed #ccc;
      padding-bottom: 5px;
    }
    .dark-mode .sidebar-entry {
      border-color: #555;
    }
    .spinner-border {
      width: 1.5rem;
      height: 1.5rem;
      margin-left: 10px;
    }
    .welcome-banner {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      background: linear-gradient(to right, #0d6efd, #6610f2);
      color: white;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }
    #export-btn, #clear-btn {
      position: fixed;
      bottom: 20px;
      z-index: 10;
    }
    #export-btn {
      right: 20px;
    }
    #clear-btn {
      left: 20px;
    }
    .tooltip-inner {
      max-width: 200px;
      font-size: 0.85rem;
    }
  </style>
</head>

<body class="light-mode">
  <div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 px-4">
      <h2 class="text-primary">üß† Ancient Greece QA Bot</h2>
      <button class="btn btn-outline-secondary" onclick="toggleDarkMode()" id="toggle-btn">üåô Dark Mode</button>
    </div>

    <div class="welcome-banner">Welcome! Ask anything about Ancient Greece üèõÔ∏è</div>

    <div class="row px-4">
      <div class="col-md-3 sidebar border">
        <h5>üï∞Ô∏è Chat History</h5>
        <div id="chat-history"></div>
      </div>

      <div class="col-md-9">
        <div class="chat-container border" id="chat-box"></div>

        <div class="input-group mt-3">
          <textarea id="question" rows="1" class="form-control" placeholder="Ask about Ancient Greece... (Shift+Enter for newline)"></textarea>
          <button class="btn btn-primary" onclick="ask()">Ask</button>
          <div id="loading-spinner" class="spinner-border text-primary d-none" role="status"></div>
        </div>
      </div>
    </div>
  </div>

  <button id="export-btn" class="btn btn-success" onclick="exportChat()">üìÅ Export</button>
  <button id="clear-btn" class="btn btn-danger" onclick="clearChat()">üßπ Clear</button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];

    async function ask() {
      const input = document.getElementById('question');
      const question = input.value.trim();
      if (!question) return;

      addMessage(question, true);
      document.getElementById("loading-spinner").classList.remove("d-none");

      const res = await fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question })
      });

      const data = await res.json();
      document.getElementById("loading-spinner").classList.add("d-none");

      addMessage(data.answer, false, data.sources);
      chatHistory.unshift({ question, answer: data.answer, sources: data.sources });
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
      renderSidebarHistory();
      input.value = '';
    }

    function addMessage(content, isUser, sources = []) {
      const chatBox = document.getElementById('chat-box');
      const avatarURL = isUser
        ? "https://api.dicebear.com/7.x/micah/svg?seed=user"
        : "https://api.dicebear.com/7.x/bottts/svg?seed=bot";

      const bubbleClass = isUser ? 'user-msg' : 'bot-msg';
      const entryClass = isUser ? 'user' : '';
      const sourceHTML = sources.length && !isUser ? `<div><em>üìÅ Sources: ${sources.join(', ')}</em></div>` : '';
      const time = new Date().toLocaleTimeString();

      const msg = `
        <div class="chat-entry ${entryClass}">
          <img src="${avatarURL}" class="avatar" title="${isUser ? 'You' : 'Bot'}">
          <div class="chat-bubble ${bubbleClass}">
            ${content}
            ${sourceHTML}
            <div class="timestamp">${time}</div>
          </div>
        </div>
      `;

      chatBox.innerHTML += msg;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function renderSidebarHistory() {
      const historyEl = document.getElementById('chat-history');
      historyEl.innerHTML = chatHistory.map(item => `
        <div class="sidebar-entry">
          <strong>Q:</strong> ${item.question}
          <strong>A:</strong> ${item.answer}
          <div><small>üìÅ ${item.sources.join(', ')}</small></div>
        </div>
      `).join('');
    }

    function toggleDarkMode() {
      const body = document.body;
      const btn = document.getElementById('toggle-btn');
      const dark = body.classList.contains('dark-mode');

      body.classList.toggle('dark-mode', !dark);
      body.classList.toggle('light-mode', dark);
      btn.innerHTML = dark ? 'üåô Dark Mode' : '‚òÄÔ∏è Light Mode';
      localStorage.setItem('theme', dark ? 'light' : 'dark');
    }

    function exportChat() {
      let text = chatHistory.map(item =>
        `Q: ${item.question}\nA: ${item.answer}\nSources: ${item.sources.join(', ')}\n`
      ).join('\n');
      const blob = new Blob([text], { type: 'text/plain' });
      const link = document.createElement('a');
      link.download = 'chat_history.txt';
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    function clearChat() {
      localStorage.removeItem('chatHistory');
      chatHistory.length = 0;
      document.getElementById('chat-box').innerHTML = '';
      document.getElementById('chat-history').innerHTML = '';
    }

    document.getElementById('question').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ask();
      }
    });

    window.onload = () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.classList.add(savedTheme + '-mode');
      document.getElementById('toggle-btn').innerHTML = savedTheme === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
      renderSidebarHistory();
    };
  </script>
</body>
</html>
